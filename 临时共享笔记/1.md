CREATE MATERIALIZED VIEW IF NOT EXISTS orion.datanode_metrics_half_hourly_avg
    ENGINE = SummingMergeTree()
    PARTITION BY toDate(process_date)
    ORDER BY (process_date, process_half_hour)
    PRIMARY KEY (process_date, process_half_hour)
    AS SELECT
        process_date,
        intDiv(toHour(etl_time) * 2 + intDiv(toMinute(etl_time), 30), 1) as process_half_hour,
        round(avg(dn_rpc_process_time_avg), 3) as avg_dn_rpc_process_time,
        round(avg(dn_rpc_queue_time_avg), 3) as avg_dn_rpc_queue_time,
        round(avg(dn_jvm_wait_threads), 0) as avg_dn_jvm_wait_threads,
        round(avg(bytes_written), 2) as avg_bytes_written,
        round(avg(bytes_read), 2) as avg_bytes_read,
        round(avg(block_read_op_avgtime), 3) as avg_block_read_op_avgtime,
        round(avg(block_write_op_avgtime), 3) as avg_block_write_op_avgtime,
        round(avg(block_reports_avgtime), 3) as avg_block_reports_avgtime,
        round(avg(node_active_xceivers_count), 0) as avg_node_active_xceivers_count,
        round(avg(heartbeats_total_avgtime), 3) as avg_heartbeats_total_avgtime,
        round(avg(packet_ack_trip_time_nanos_avg), 3) as avg_packet_ack_trip_time_nanos,
        round(avg(volume_failures), 0) as avg_volume_failures,
        count(*) as record_count,
        count(DISTINCT ip_address) as node_count
    FROM {source_table}
    WHERE 1=1 {exclude_condition}
    GROUP BY
        process_date,
        intDiv(toHour(etl_time) * 2 + intDiv(toMinute(etl_time), 30), 1)
-- DataNode节点指标
    CREATE TABLE IF NOT EXISTS orion.datanode_metrics (
        node_id String COMMENT '节点ID',
        ip_address String COMMENT 'IP地址',
        dn_rpc_process_time_avg Decimal64(3) DEFAULT 0.000 COMMENT 'RPC平均处理时间',
        dn_rpc_queue_time_avg Decimal64(3) DEFAULT 0.000 COMMENT 'RPC平均队列时间',
        dn_jvm_wait_threads UInt32 DEFAULT 0 COMMENT 'JVM等待线程数',
        bytes_written Float64 DEFAULT 0 COMMENT '写入字节数',
        bytes_read Float64 DEFAULT 0 COMMENT '读取字节数',
        block_read_op_avgtime Decimal64(3) DEFAULT 0.000 COMMENT '块读取操作平均时间',
        block_write_op_avgtime Decimal64(3) DEFAULT 0.000 COMMENT '块写入操作平均时间',
        block_reports_avgtime Decimal64(3) DEFAULT 0.000 COMMENT '块报告平均时间',
        node_active_xceivers_count UInt32 DEFAULT 0 COMMENT '节点活跃接收器数量',
        heartbeats_total_avgtime Decimal64(3) DEFAULT 0.000 COMMENT '心跳总平均时间',
        packet_ack_trip_time_nanos_avg Decimal64(3) DEFAULT 0.000 COMMENT '包确认往返时间纳秒平均值',
        volume_failures UInt32 DEFAULT 0 COMMENT '卷故障数',
        etl_time DateTime COMMENT 'ETL时间',
        process_date Date COMMENT '处理日期'
    ) ENGINE = MergeTree()
    PARTITION BY toYYYYMM(process_date)
    ORDER BY (node_id, process_date, etl_time)
    PRIMARY KEY (node_id, process_date, etl_time)


CREATE TABLE namenode_metrics (
    node_id String COMMENT '节点ID',
    cluster_id String COMMENT '集群ID',
    ip_address String COMMENT 'IP地址',
    call_queue_length UInt32 DEFAULT 0 COMMENT '调用队列长度',
    nn_read_ops UInt64 DEFAULT 0 COMMENT 'NameNode读操作数',
    nn_write_ops UInt64 DEFAULT 0 COMMENT 'NameNode写操作数',
    rpc_process_time_avg Decimal64(3) DEFAULT 0.000 COMMENT 'RPC平均处理时间',
    rpc_queue_time_avg Decimal64(3) DEFAULT 0.000 COMMENT 'RPC平均队列时间',
    gc_count UInt32 DEFAULT 0 COMMENT 'GC次数',
    gc_time_ms UInt32 DEFAULT 0 COMMENT 'GC时间毫秒',
    heap_mem_used Decimal64(3) DEFAULT 0.000 COMMENT '堆内存使用量',
    non_heap_mem_used Decimal64(3) DEFAULT 0.000 COMMENT '非堆内存使用量',
    etl_time DateTime COMMENT 'ETL时间',
    process_date Date COMMENT '处理日期'
) ENGINE = MergeTree()
PARTITION BY toYYYYMM(process_date)
ORDER BY (node_id, process_date, etl_time)
PRIMARY KEY (node_id, process_date, etl_time);

    CREATE TABLE IF NOT EXISTS orion.hdfs_cluster_metrics (
        cluster_id String COMMENT '集群ID',
        capacity_total Decimal64(3) DEFAULT 0.000 COMMENT '总容量(PB)',
        capacity_used Decimal64(3) DEFAULT 0.000 COMMENT '已用容量(PB)',
        capacity_remaining Decimal64(3) DEFAULT 0.000 COMMENT '剩余容量(PB)',
        capacity_used_percent Decimal32(2) DEFAULT 0.00 COMMENT '容量使用率(%)',
        blocks_total UInt64 DEFAULT 0 COMMENT '总块数',
        files_total UInt64 DEFAULT 0 COMMENT '总文件数',
        missing_blocks UInt32 DEFAULT 0 COMMENT '丢失块数',
        corrupt_blocks UInt32 DEFAULT 0 COMMENT '损坏块数',
        live_datanodes_num UInt32 DEFAULT 0 COMMENT '活跃DataNode数量',
        dead_datanodes_num UInt32 DEFAULT 0 COMMENT '死亡DataNode数量',
        etl_time DateTime COMMENT 'ETL时间',
        process_date Date COMMENT '处理日期'
    ) ENGINE = MergeTree()
    PARTITION BY toYYYYMM(process_date)
    ORDER BY (cluster_id, process_date, etl_time)
    PRIMARY KEY (cluster_id, process_date, etl_time)